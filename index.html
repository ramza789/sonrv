<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Location Tracker</title>
    <!-- React and ReactDOM CDN -->
    <script
      crossorigin
      src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"
    ></script>
    <script
      crossorigin
      src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"
    ></script>
    <!-- Babel for JSX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <!-- Google Maps -->
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyADPTzE5wBrMXV3nPb1sHX5MIuYFUY8VYs&callback=initMap&libraries=geometry,places"
      async
      defer
    ></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      #map {
        height: 100vh;
        width: 100%;
      }
      .info-panel {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        z-index: 1000;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect } = React;

      function App() {
        const [map, setMap] = useState(null);
        const [markers, setMarkers] = useState([]);
        const [userCount, setUserCount] = useState(0);

        useEffect(() => {
          initializeMap();
        }, []);

        const initializeMap = () => {
          const mapInstance = new google.maps.Map(
            document.getElementById("map"),
            {
              center: { lat: 0, lng: 0 },
              zoom: 2,
              styles: [
                {
                  featureType: "poi",
                  elementType: "labels",
                  stylers: [{ visibility: "off" }],
                },
              ],
            }
          );
          setMap(mapInstance);
          getCurrentUserLocation(mapInstance);
        };

        const generateUserId = () => {
          const existingId = localStorage.getItem("userId");
          if (existingId) return existingId;

          const newId = "user_" + Math.random().toString(36).substr(2, 9);
          localStorage.setItem("userId", newId);
          return newId;
        };

        const getCurrentUserLocation = (mapInstance) => {
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              (position) => {
                const userLocation = {
                  lat: position.coords.latitude,
                  lng: position.coords.longitude,
                  timestamp: new Date().toISOString(),
                  userId: generateUserId(),
                };

                // Store current user's location
                localStorage.setItem(
                  "currentUserLocation",
                  JSON.stringify(userLocation)
                );

                // Update users array
                const users = JSON.parse(localStorage.getItem("users") || "[]");
                const existingUserIndex = users.findIndex(
                  (u) => u.userId === userLocation.userId
                );

                if (existingUserIndex >= 0) {
                  users[existingUserIndex] = userLocation;
                } else {
                  users.push(userLocation);
                }

                localStorage.setItem("users", JSON.stringify(users));
                setUserCount(users.length);
                updateMarkers(mapInstance, users);

                // Center map on current user
                mapInstance.setCenter({
                  lat: userLocation.lat,
                  lng: userLocation.lng,
                });
                mapInstance.setZoom(13);
              },
              (error) => {
                console.error("Error getting location:", error);
                alert(
                  "Error getting location. Please enable location services."
                );
              }
            );
          }
        };

        const updateMarkers = (mapInstance, users) => {
          // Clear existing markers
          markers.forEach((marker) => marker.setMap(null));
          const newMarkers = [];

          users.forEach((user) => {
            const isCurrentUser =
              user.userId === localStorage.getItem("userId");

            const marker = new google.maps.Marker({
              position: { lat: user.lat, lng: user.lng },
              map: mapInstance,
              title: `User ${user.userId}`,
              icon: isCurrentUser
                ? {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 10,
                    fillColor: "#4285F4",
                    fillOpacity: 1,
                    strokeColor: "#FFFFFF",
                    strokeWeight: 2,
                  }
                : undefined,
            });

            const infoWindow = new google.maps.InfoWindow({
              content: `
                            <div style="padding: 10px;">
                                <h3>${
                                  isCurrentUser ? "You" : "User " + user.userId
                                }</h3>
                                <p>Last seen: ${new Date(
                                  user.timestamp
                                ).toLocaleString()}</p>
                                <p>Lat: ${user.lat.toFixed(6)}</p>
                                <p>Lng: ${user.lng.toFixed(6)}</p>
                            </div>
                        `,
            });

            marker.addListener("click", () => {
              infoWindow.open(mapInstance, marker);
            });

            newMarkers.push(marker);
          });

          setMarkers(newMarkers);
        };

        useEffect(() => {
          if (map) {
            const intervalId = setInterval(() => {
              getCurrentUserLocation(map);
            }, 20000); // Update every 20 seconds

            return () => clearInterval(intervalId);
          }
        }, [map]);

        return (
          <>
            <div id="map"></div>
            <div className="info-panel">
              <h3>Active users: {userCount}</h3>
              <p>Updated: {new Date().toLocaleTimeString()}</p>
            </div>
          </>
        );
      }

      // Render the app
      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
